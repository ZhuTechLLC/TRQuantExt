# -*- coding: utf-8 -*-
"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant




"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant




"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant






"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant




"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant




"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant






"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant




"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant




"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant






"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant




"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant




"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant






"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant




"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant




"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant






"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant




"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant




"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant






"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant




"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant




"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant






"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant




"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant




"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant






"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant




"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant




"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant






"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant




"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant




"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant

"""
AI策略助手
集成大模型辅助策略开发

支持功能：
1. 策略代码生成
2. 策略优化建议
3. 回测结果分析
4. 因子挖掘建议
"""
from typing import Dict, List, Optional
from dataclasses import dataclass
from pathlib import Path
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    description: str
    template: str
    variables: List[str]


class AIAssistant:
    """
    AI策略助手
    
    生成专业的Prompt供用户在Cursor或其他AI工具中使用
    """
    
    # 预定义提示词模板
    TEMPLATES = {
        'generate_strategy': PromptTemplate(
            name="生成策略",
            description="根据描述生成量化策略代码",
            template="""请帮我生成一个量化交易策略，要求如下：

## 策略描述
{description}

## 技术要求
- 基于Python实现
- 继承BaseStrategy基类
- 实现on_bar方法处理每日数据
- 支持参数配置

## 策略框架参考
```python
from strategies.base_strategy import BaseStrategy
import numpy as np

class {strategy_name}(BaseStrategy):
    name = "{strategy_id}"
    version = "1.0"
    
    def __init__(self, **params):
        super().__init__()
        # 策略参数
        
    def on_bar(self, date, data, portfolio):
        '''
        每日执行的交易逻辑
        
        Args:
            date: 当前日期
            data: 行情数据 DataFrame
            portfolio: 投资组合对象
        
        Returns:
            list: 交易信号列表
        '''
        signals = []
        # 实现交易逻辑
        return signals
```

## 额外要求
{requirements}

请生成完整的策略代码，包含详细注释。""",
            variables=['description', 'strategy_name', 'strategy_id', 'requirements']
        ),
        
        'optimize_strategy': PromptTemplate(
            name="优化策略",
            description="分析并优化现有策略代码",
            template="""请帮我分析和优化以下量化策略代码：

## 当前策略代码
```python
{code}
```

## 回测结果
{backtest_results}

## 优化方向
请从以下几个方面给出优化建议：

1. **性能优化**
   - 代码执行效率
   - 内存使用优化
   - 数据处理优化

2. **策略逻辑优化**
   - 入场条件改进
   - 出场条件改进
   - 仓位管理优化

3. **风险控制**
   - 止损止盈设置
   - 最大回撤控制
   - 仓位分散

4. **代码质量**
   - 代码规范
   - 错误处理
   - 可维护性

请给出具体的代码修改建议和优化后的代码。""",
            variables=['code', 'backtest_results']
        ),
        
        'analyze_backtest': PromptTemplate(
            name="分析回测",
            description="分析回测结果并给出改进建议",
            template="""请帮我分析以下回测结果：

## 策略信息
- 策略名称: {strategy_name}
- 回测区间: {start_date} 至 {end_date}
- 初始资金: {initial_capital}

## 回测指标
{metrics}

## 交易记录摘要
{trade_summary}

请从以下几个方面进行分析：

1. **收益分析**
   - 总收益率评估
   - 年化收益评估
   - 与基准对比

2. **风险分析**
   - 最大回撤分析
   - 波动率分析
   - 夏普比率评估

3. **交易分析**
   - 胜率分析
   - 盈亏比分析
   - 持仓周期分析

4. **改进建议**
   - 策略逻辑改进
   - 参数优化方向
   - 风控措施建议

请给出详细的分析报告和可行的改进建议。""",
            variables=['strategy_name', 'start_date', 'end_date', 'initial_capital', 
                      'metrics', 'trade_summary']
        ),
        
        'explain_strategy': PromptTemplate(
            name="解释策略",
            description="解释策略代码的交易逻辑",
            template="""请帮我详细解释以下量化策略的交易逻辑：

## 策略代码
```python
{code}
```

请从以下几个方面进行解释：

1. **策略原理**
   - 核心交易思想
   - 使用的技术指标
   - 信号生成逻辑

2. **买卖信号**
   - 入场条件详解
   - 出场条件详解
   - 信号触发时机

3. **风险特征**
   - 适用市场环境
   - 潜在风险点
   - 风险控制措施

4. **参数说明**
   - 各参数含义
   - 参数敏感性分析
   - 推荐参数范围

请用通俗易懂的语言解释，适合量化初学者理解。""",
            variables=['code']
        ),
        
        'factor_mining': PromptTemplate(
            name="因子挖掘",
            description="基于数据特征挖掘有效因子",
            template="""请帮我挖掘可能有效的量化因子：

## 目标市场
{market}

## 投资风格
{style}

## 已有因子
{existing_factors}

## 数据可用性
{available_data}

请从以下几个方面给出因子建议：

1. **动量类因子**
   - 价格动量
   - 成交量动量
   - 资金流动量

2. **价值类因子**
   - 估值因子
   - 盈利因子
   - 成长因子

3. **技术类因子**
   - 趋势因子
   - 波动率因子
   - 形态因子

4. **另类因子**
   - 情绪因子
   - 事件因子
   - 行业因子

请给出因子的计算公式、理论依据和预期效果。""",
            variables=['market', 'style', 'existing_factors', 'available_data']
        ),
        
        'qmt_strategy': PromptTemplate(
            name="QMT策略",
            description="生成适用于QMT平台的策略代码",
            template="""请帮我生成适用于QMT(miniQMT)平台的策略代码：

## 策略描述
{description}

## QMT API参考
- 使用xtquant库
- 支持股票、ETF交易
- 支持限价单、市价单

## 代码框架
```python
# -*- coding: utf-8 -*-
from xtquant import xtdata
from xtquant.xttrader import XtQuantTrader
from xtquant.xttype import StockAccount

class QMTStrategy:
    def __init__(self, account_id: str, path: str):
        self.account = StockAccount(account_id)
        self.trader = XtQuantTrader(path, 0)
        
    def on_bar(self, data):
        '''K线回调'''
        pass
    
    def on_tick(self, data):
        '''Tick回调'''
        pass
```

## 要求
{requirements}

请生成完整的QMT策略代码。""",
            variables=['description', 'requirements']
        ),
        
        'ptrade_strategy': PromptTemplate(
            name="PTrade策略",
            description="生成适用于PTrade平台的策略代码",
            template="""请帮我生成适用于PTrade平台的策略代码：

## 策略描述
{description}

## PTrade环境
- Python 3.11
- 恒生PTrade系统

## 代码框架
```python
# -*- coding: utf-8 -*-
# PTrade策略

def initialize(context):
    '''初始化'''
    pass

def handle_data(context, data):
    '''每日执行'''
    pass

def before_trading_start(context, data):
    '''盘前'''
    pass

def after_trading_end(context, data):
    '''盘后'''
    pass
```

## 要求
{requirements}

请生成完整的PTrade策略代码。""",
            variables=['description', 'requirements']
        ),
    }
    
    def __init__(self):
        self.templates = self.TEMPLATES.copy()
        self._load_custom_templates()
    
    def _load_custom_templates(self):
        """加载自定义模板"""
        templates_dir = Path(__file__).parent.parent / "config" / "ai_templates"
        if templates_dir.exists():
            for file in templates_dir.glob("*.json"):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        template = PromptTemplate(**data)
                        self.templates[template.name] = template
                except Exception as e:
                    logger.warning(f"加载模板失败: {file} - {e}")
    
    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """获取模板"""
        return self.templates.get(name)
    
    def list_templates(self) -> List[str]:
        """列出所有模板"""
        return list(self.templates.keys())
    
    def generate_prompt(self, template_name: str, **kwargs) -> str:
        """
        生成提示词
        
        Args:
            template_name: 模板名称
            **kwargs: 模板变量
        
        Returns:
            str: 生成的提示词
        """
        template = self.templates.get(template_name)
        if not template:
            raise ValueError(f"模板不存在: {template_name}")
        
        # 填充变量
        prompt = template.template
        for var in template.variables:
            value = kwargs.get(var, f"[请填写{var}]")
            prompt = prompt.replace(f"{{{var}}}", str(value))
        
        return prompt
    
    # ==================== 便捷方法 ====================
    
    def generate_strategy_prompt(
        self,
        description: str,
        strategy_name: str = "NewStrategy",
        strategy_id: str = "new_strategy",
        requirements: str = ""
    ) -> str:
        """生成策略代码的提示词"""
        return self.generate_prompt(
            'generate_strategy',
            description=description,
            strategy_name=strategy_name,
            strategy_id=strategy_id,
            requirements=requirements
        )
    
    def optimize_strategy_prompt(
        self,
        code: str,
        backtest_results: str = ""
    ) -> str:
        """生成优化策略的提示词"""
        return self.generate_prompt(
            'optimize_strategy',
            code=code,
            backtest_results=backtest_results
        )
    
    def analyze_backtest_prompt(
        self,
        strategy_name: str,
        start_date: str,
        end_date: str,
        initial_capital: float,
        metrics: Dict,
        trade_summary: str = ""
    ) -> str:
        """生成分析回测的提示词"""
        metrics_str = "\n".join([f"- {k}: {v}" for k, v in metrics.items()])
        
        return self.generate_prompt(
            'analyze_backtest',
            strategy_name=strategy_name,
            start_date=start_date,
            end_date=end_date,
            initial_capital=initial_capital,
            metrics=metrics_str,
            trade_summary=trade_summary
        )
    
    def explain_strategy_prompt(self, code: str) -> str:
        """生成解释策略的提示词"""
        return self.generate_prompt('explain_strategy', code=code)
    
    def factor_mining_prompt(
        self,
        market: str = "A股",
        style: str = "价值投资",
        existing_factors: str = "",
        available_data: str = "日K线、财务数据、行业数据"
    ) -> str:
        """生成因子挖掘的提示词"""
        return self.generate_prompt(
            'factor_mining',
            market=market,
            style=style,
            existing_factors=existing_factors,
            available_data=available_data
        )
    
    def qmt_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成QMT策略的提示词"""
        return self.generate_prompt(
            'qmt_strategy',
            description=description,
            requirements=requirements
        )
    
    def ptrade_strategy_prompt(
        self,
        description: str,
        requirements: str = ""
    ) -> str:
        """生成PTrade策略的提示词"""
        return self.generate_prompt(
            'ptrade_strategy',
            description=description,
            requirements=requirements
        )
    
    def copy_to_clipboard(self, prompt: str) -> bool:
        """复制到剪贴板"""
        try:
            import pyperclip
            pyperclip.copy(prompt)
            return True
        except ImportError:
            logger.warning("pyperclip未安装，无法复制到剪贴板")
            return False
        except Exception as e:
            logger.error(f"复制到剪贴板失败: {e}")
            return False


class CursorIntegration:
    """
    Cursor IDE集成
    
    支持与Cursor IDE的交互
    """
    
    @staticmethod
    def open_in_cursor(file_path: str) -> bool:
        """在Cursor中打开文件"""
        import subprocess
        try:
            subprocess.Popen(['cursor', file_path])
            return True
        except FileNotFoundError:
            logger.warning("Cursor未安装或不在PATH中")
            return False
        except Exception as e:
            logger.error(f"打开Cursor失败: {e}")
            return False
    
    @staticmethod
    def create_cursor_prompt_file(prompt: str, output_dir: str = None) -> str:
        """创建Cursor提示词文件"""
        if output_dir is None:
            output_dir = Path(__file__).parent.parent / "prompts"
        
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)
        
        from datetime import datetime
        filename = f"prompt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(prompt)
        
        return str(file_path)


# 全局实例
_ai_assistant = None


def get_ai_assistant() -> AIAssistant:
    """获取AI助手实例"""
    global _ai_assistant
    if _ai_assistant is None:
        _ai_assistant = AIAssistant()
    return _ai_assistant














