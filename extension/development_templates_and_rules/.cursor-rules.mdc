---
description: "项目AI协作规则配置"
globs: "**/*.py, **/*.ts, **/*.js, **/*.tsx, **/*.jsx"
alwaysApply: true
---

# Cursor 规则 (Cursor Rules)

*由于大型语言模型存在上下文窗口限制、风格多样等问题, 本规则文件旨在为AI提供持久统一的项目上下文, 帮助其生成符合规范的一致代码.*

## 风格规范

- 遵循 DRY (Don't Repeat Yourself，勿重复) 原则，避免重复代码。

- 确保代码风格一致，如 Python 代码遵循 PEP8 规范，TypeScript/JavaScript 代码遵循统一的 ESLint/Prettier 规则 (使用单引号，必要时使用分号等)。

- 所有标识符（变量、函数、类名等）使用英文命名，遵循项目命名规范（例如变量使用`camelCase`或`snake_case`，常量使用`UPPER_SNAKE_CASE`等）。

## 架构约定

- 本项目由后端 Web 服务和 VSCode 插件组成，代码必须保持两者的解耦。插件通过定义良好的 API 与后端通信，不直接依赖内部实现。

- 模块边界清晰，各模块只通过公开接口交互，不擅自调用其他模块的内部函数或变量。

- 在代码生成时，**始终参考** `PROJECT_BRIEF.md` 获取项目概览和架构上下文。

- 如果任务涉及特定模块，实现前请查阅 `MODULE_INDEX.md` 了解模块职责和接口，以确保将代码放在正确位置。

## 容错与健壮性

- 在可能发生错误的地方添加适当的错误处理，例如网络请求、文件读写需使用异常捕获，插件调用后端失败时给予友好提示。

- 确保所有对外接口对输入进行验证（后端API检查参数合法性，插件命令校验用户输入），防止无效数据导致崩溃。

- 后端服务出现未捕获异常时，不应导致整个服务崩溃，应记录错误日志并安全恢复或退出。

## 接口一致性

- API 设计保持风格一致：RESTful 风格使用统一的动词语义和HTTP状态码，响应使用统一格式（如{ code, message, data } JSON结构）。

- 函数和方法命名表达清楚的动作，与其功能相符；相似功能的接口在不同模块中命名应尽量统一，参数顺序也保持一致。

- VSCode插件提供的命令、设置项与后端API名称应有对应关系，命名保持一致以便维护。

## 日志与调试

- 后端使用统一的日志框架，按照 debug/info/warning/error 等级输出日志。错误应包含充分信息定位问题，但避免暴露敏感数据。

- VSCode插件应使用输出通道记录重要事件和错误，方便用户查看且不扰乱正常使用。

- 日志内容简洁明了，包含时间戳和模块来源。对性能关键路径，可在调试阶段加入统计信息，但注意在发布版本中移除或降级日志级别。

## 测试要求

- 所有核心函数和模块需要编写单元测试，确保逻辑正确覆盖主要分支。特别是定量算法和关键业务逻辑部分，应有充足的测试用例。

- 提交新功能前，应通过全部自动测试。若修改影响到已有功能，需相应更新测试。

- 测试命名规范：测试文件应存放在 `tests/` 目录，对应被测模块命名，并以 `.test.[语言后缀]` 结尾（例如`example.test.js`）。测试函数名称需描述测试意图。

## 文档与维护

- 代码需包含适当注释和文档字符串解释函数意图、参数和返回。公共接口和复杂逻辑应在代码注释或相应 MD 文档详细说明。

- 当项目架构或约定发生变更，需同步更新 `PROJECT_BRIEF.md`、`MODULE_INDEX.md` 等文档，以及更新本规则文件以保持一致。

- AI 生成代码后，开发者应审查其是否遵循上述规范。如有偏差，需在提示中明确强调相关规则，确保下次生成结果符合预期。

## TRQuant 特定约定

- **命令ID**：所有命令ID必须以`trquant.`开头，如`trquant.getMarketStatus`、`trquant.runBacktest`

- **Python Bridge**：与Python通信时，必须使用`TRQuantClient`服务，不要直接创建子进程。所有Bridge调用必须处理超时和错误。

- **WebView面板**：所有面板类必须实现单例模式（静态`currentPanel`），实现`dispose`方法清理资源，使用`handleMessage`处理消息。

- **服务层**：服务类使用依赖注入，通过构造函数接收依赖。全局服务使用`getInstance()`单例模式。

- **类型定义**：所有类型定义放在`types/index.ts`中，使用`export type`或`export interface`导出。

- **日志记录**：使用`logger`工具统一记录日志，格式为`logger.info(message, MODULE)`，MODULE常量定义在文件顶部。

- **错误处理**：使用`ErrorHandler`统一处理错误，抛出`TRQuantError`而非原生Error。

- **项目结构**：新功能按类型放在对应目录：命令→`commands/`，视图→`views/`，服务→`services/`，工具→`utils/`

- **策略优化器**：代码分析使用正则表达式和字符串解析，避免引入重型AST库。平台转换维护完整的API映射表。

- **学习引擎**：知识库使用JSON文件持久化，支持增量更新。支持文件监听实现实时学习。
