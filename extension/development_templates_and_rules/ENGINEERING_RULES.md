# 工程编码规范 (Engineering Rules)

本指南定义了项目的编码规范和工程约定，旨在提高代码可维护性和一致性，遵循软件工程最佳实践。

## 遵循 DRY 原则

- **Don't Repeat Yourself (DRY，勿重复)**：避免在代码中出现重复的逻辑或信息。如果发现多个模块或函数存在相似代码，应提取为公共函数或模块以复用。

- 遵循DRY可以减少维护工作量，一处修改即可影响所有相关部分，降低错误风险。在项目中持续审视代码，及时重构消除重复。

## 容错与异常处理

- **预判错误**：在编写代码时主动考虑可能的异常情况（如网络故障、无效输入）并做好处理。防止错误未被捕获就传播导致崩溃。

- **异常处理**：使用适当的错误处理结构（如`try/except`或Promise的`.catch`）捕获并处理异常。提供有意义的错误信息或备用方案，让系统对异常情况有合理反应。

- **健壮性**：绝不忽略返回值或错误码。对函数调用的结果进行检查，例如数据库操作后确认影响行数、外部接口调用检查响应状态，保证系统行为符合预期。

- **失败转移**：对于关键任务，考虑fallback策略或重试机制，提高系统整体健壮性。避免单点故障使整个服务不可用。

## 接口设计与一致性

- **统一风格**：项目中API接口、模块方法的设计风格保持一致。例如所有API路径采用`kebab-case`命名，HTTP响应采用统一的JSON结构（如`{ code, data, message }`）。

- **清晰语义**：接口命名应能自解释功能，例如`getPortfolio()`应确实返回投资组合数据。避免使用模糊或不一致的命名导致误解。

- **参数顺序**：对于类似功能的函数，参数顺序和含义保持一致。例如CRUD操作函数统一将数据对象作为第一个参数、可选配置作为第二个参数。

- **文档化**：所有公开接口在定义处添加注释文档，说明用途、参数、返回及可能异常，方便他人使用且利于AI理解上下文。

## 测试要求

- **单元测试**：对每个核心业务模块编写单元测试，用于验证模块内部逻辑的正确性。测试应覆盖正常情况、边界情况和异常情况，确保代码健壮性。

- **集成测试**：对于涉及多个模块交互的功能，编写集成测试模拟实际使用场景，验证模块间协作是否正常。例如测试插件通过API调用后端的完整流程是否按预期工作。

- **测试频率**：鼓励TDD（测试驱动开发）或至少在实现功能后立即编写测试。确保CI/CD中所有测试通过后才可合并代码。

- **测试命名**：测试代码与被测代码对应命名，测试函数描述测试目的。测试文件建议以`.test`后缀命名（如`tradeService.test.js`）以清晰标识。

## 日志记录与调试

- **日志级别**：使用统一的日志框架，根据重要性使用不同级别(`DEBUG/INFO/WARN/ERROR`)记录。避免过度输出影响性能，重要信息才提升日志级别。

- **内容规范**：日志消息应清晰描述事件，包括必要的上下文（如操作对象ID）。错误日志应包含栈追踪或错误码，方便定位问题，但避免泄露敏感信息。

- **格式统一**：采用一致的日志格式，例如`[时间][模块][级别]: 消息`。这样有助于在多模块、多环境下汇总分析日志。

- **调试建议**：利用日志进行问题排查时，可临时提高相关模块日志级别，并在修复后将其恢复。提交代码前，移除调试用途的临时日志，保持日志简洁。

## 命名规范

- **通用约定**：代码中命名采用英文，避免拼音或生僻缩写。使用具有意义的单词组合命名，见名知意。

- **后端代码**：遵循语言惯例，例如Python代码中的变量和函数使用`snake_case`，类名使用`PascalCase`；JavaScript/TypeScript中的变量和函数使用`camelCase`，类名使用`PascalCase`，常量使用全大写下划线风格。

- **文件及目录**：使用有意义的英文单词命名，目录采用复数名词表示其包含资源（如`services/`, `models/`），文件名体现内容用途（如`user_controller.ts`表示用户控制器）。

- **配置与脚本**：对于配置文件使用全小写加短横线命名（如`database-config.yaml`），可执行脚本尽量以动词开头表明动作（如`init-db.sh`）。

## VS Code Extension 特定规范

### 命令注册

- **命令ID命名**：统一使用`trquant.`前缀，如`trquant.getMarketStatus`、`trquant.runBacktest`
- **命令注册位置**：在`extension.ts`的`activate`函数中统一注册，或通过专门的注册函数
- **命令实现**：每个命令对应`commands/`目录下的一个文件，文件名为命令功能（如`getMarketStatus.ts`）
- **错误处理**：命令执行必须包含try-catch，使用`vscode.window.showErrorMessage`显示错误

### WebView面板

- **面板类命名**：使用`Panel`后缀，如`MainDashboard`、`BacktestConfigPanel`
- **单例模式**：面板类使用静态`currentPanel`实现单例，避免重复创建
- **消息处理**：统一使用`handleMessage`方法处理WebView消息，使用`postMessage`向WebView发送消息
- **资源清理**：实现`dispose`方法，清理所有`Disposable`资源
- **HTML生成**：使用`_getHtml()`私有方法生成HTML内容，支持本地资源引用

### Python Bridge通信

- **协议格式**：严格遵循JSON格式，请求包含`action`和`params`，响应包含`ok`、`data`、`error`
- **错误处理**：Python异常必须转换为JSON格式返回，包含错误码和消息
- **超时处理**：所有Bridge调用必须设置超时（建议30秒），超时后清理子进程
- **日志输出**：Python的stdout/stderr输出需要重定向，避免干扰JSON解析
- **子进程管理**：使用`TRQuantClient`统一管理Python子进程，避免资源泄漏

### 服务层设计

- **依赖注入**：服务类通过构造函数接收依赖，便于测试和替换
- **单例服务**：使用`getInstance()`模式管理全局服务（如`ConfigManager`）
- **异步处理**：所有IO操作（文件、网络、子进程）必须使用async/await
- **类型安全**：使用TypeScript严格模式，所有接口定义类型

### 类型定义

- **集中管理**：所有类型定义放在`types/index.ts`中，统一导出
- **接口命名**：使用`I`前缀或直接使用描述性名称（如`MarketStatus`、`BacktestResult`）
- **类型导出**：使用`export type`或`export interface`导出，避免值导出
- **文档注释**：所有公开类型必须添加JSDoc注释

## 策略优化器特定规范

### 代码分析

- **AST解析**：使用正则表达式和字符串解析，避免引入重型AST库
- **模式识别**：定义清晰的模式规则，支持扩展和配置
- **兼容性评估**：为每个平台计算兼容性得分，提供具体改进建议

### 平台转换

- **API映射**：维护完整的API映射表，包含参数转换规则
- **代码生成**：使用模板字符串生成代码，支持变量替换
- **变更追踪**：记录所有代码变更，包括类型、行号、原因

### 学习引擎

- **知识存储**：使用JSON文件持久化知识库，支持增量更新
- **实时学习**：支持文件监听，自动学习更新的文档
- **推荐算法**：基于代码分析结果，智能推荐相关模式和最佳实践

## 其他最佳实践

- **KISS原则**：Keep It Simple, Stupid —— 保持设计简单。优先使用简单清晰的实现，避免过早优化或过度设计导致不必要复杂度。

- **YAGNI原则**：You Aren't Gonna Need It —— 不要实现暂时不需要的功能。专注当前需求，避免加入冗余代码增加维护成本。

- **代码审查**：主动进行代码Review，即使是单人项目也可借助AI或自行检查来发现问题。审查关注代码逻辑、可读性、规范遵循情况，确保质量。

- **持续重构**：定期重构代码以改善结构和可读性。在保证测试通过的前提下，小步优化，减少技术债务，保持代码健康演进。

- **模块化设计**：每个模块职责单一，接口清晰，便于测试和维护

- **文档同步**：代码变更时同步更新相关文档，保持文档与代码一致

