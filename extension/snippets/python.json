{
  "TRQuant PTrade Strategy Template": {
    "prefix": ["trq-strategy", "ptrade-strategy"],
    "body": [
      "# -*- coding: utf-8 -*-",
      "\"\"\"",
      "${1:策略名称}",
      "================",
      "",
      "策略描述: ${2:多因子选股策略}",
      "平台: PTrade",
      "\"\"\"",
      "",
      "# ============ 全局变量 ============",
      "g = None",
      "",
      "# ============ 风控参数 ============",
      "MAX_POSITION = ${3:0.1}  # 单票最大仓位",
      "STOP_LOSS = ${4:0.08}    # 止损线",
      "TAKE_PROFIT = ${5:0.2}   # 止盈线",
      "",
      "",
      "def initialize(context):",
      "    \"\"\"策略初始化\"\"\"",
      "    global g",
      "    g = context.global_data",
      "    ",
      "    # 设置基准",
      "    set_benchmark('000300.XSHG')",
      "    ",
      "    # 设置滑点",
      "    set_slippage(PriceRelatedSlippage(0.002))",
      "    ",
      "    # 设置手续费",
      "    set_commission(PerOrder(buy_cost=0.0003, sell_cost=0.0013, min_cost=5))",
      "    ",
      "    # 持仓记录",
      "    g.positions = {}",
      "    g.buy_prices = {}",
      "    ",
      "    log.info(\"策略初始化完成\")",
      "",
      "",
      "def before_trading_start(context):",
      "    \"\"\"盘前准备\"\"\"",
      "    # 获取股票池",
      "    g.stocks = get_index_stocks('000300.XSHG')",
      "    ",
      "    # 过滤",
      "    g.stocks = filter_stocks(g.stocks)",
      "",
      "",
      "def handle_data(context, data):",
      "    \"\"\"主交易逻辑\"\"\"",
      "    # 1. 风控检查",
      "    check_risk(context, data)",
      "    ",
      "    # 2. 获取信号",
      "    signals = get_signals(context, data)",
      "    ",
      "    # 3. 执行交易",
      "    execute_trades(context, signals)",
      "",
      "",
      "def get_signals(context, data):",
      "    \"\"\"获取交易信号\"\"\"",
      "    signals = {}",
      "    # TODO: 实现选股逻辑",
      "    return signals",
      "",
      "",
      "def check_risk(context, data):",
      "    \"\"\"风控检查\"\"\"",
      "    for stock in list(context.portfolio.positions.keys()):",
      "        pos = context.portfolio.positions[stock]",
      "        if stock in g.buy_prices:",
      "            pnl = (pos.price - g.buy_prices[stock]) / g.buy_prices[stock]",
      "            if pnl <= -STOP_LOSS or pnl >= TAKE_PROFIT:",
      "                order_target_percent(stock, 0)",
      "                del g.buy_prices[stock]",
      "",
      "",
      "def execute_trades(context, signals):",
      "    \"\"\"执行交易\"\"\"",
      "    if not signals:",
      "        return",
      "    ",
      "    sorted_stocks = sorted(signals.items(), key=lambda x: x[1], reverse=True)",
      "    target_count = min(10, len(sorted_stocks))",
      "    weight = min(MAX_POSITION, 1.0 / target_count)",
      "    ",
      "    for stock, score in sorted_stocks[:target_count]:",
      "        if stock not in context.portfolio.positions:",
      "            order_target_percent(stock, weight)",
      "            g.buy_prices[stock] = get_current_data()[stock].last_price",
      "",
      "",
      "def filter_stocks(stocks):",
      "    \"\"\"过滤股票\"\"\"",
      "    return [s for s in stocks if not is_st(s) and not is_suspended(s)]",
      ""
    ],
    "description": "完整的PTrade策略模板"
  },

  "TRQuant QMT Strategy Template": {
    "prefix": ["trq-qmt", "qmt-strategy"],
    "body": [
      "# -*- coding: utf-8 -*-",
      "\"\"\"",
      "${1:策略名称} (QMT版本)",
      "========================",
      "",
      "策略描述: ${2:多因子选股策略}",
      "平台: QMT (迅投)",
      "\"\"\"",
      "",
      "from xtquant import xtdata",
      "from xtquant.xttrader import XtQuantTrader",
      "from xtquant.xttype import StockAccount",
      "",
      "# ============ 风控参数 ============",
      "MAX_POSITION = ${3:0.1}",
      "STOP_LOSS = ${4:0.08}",
      "TAKE_PROFIT = ${5:0.2}",
      "",
      "",
      "class G:",
      "    \"\"\"全局变量\"\"\"",
      "    positions = {}",
      "    buy_prices = {}",
      "",
      "g = G()",
      "",
      "",
      "def init(ContextInfo):",
      "    \"\"\"初始化\"\"\"",
      "    ContextInfo.run_time('handlebar', '1d', '2023-01-01', '09:30:00')",
      "    print(\"策略初始化完成\")",
      "",
      "",
      "def handlebar(ContextInfo):",
      "    \"\"\"主交易函数\"\"\"",
      "    # 获取持仓",
      "    positions = ContextInfo.get_trade_detail_data(",
      "        ContextInfo.accout_id, 'stock', 'position'",
      "    )",
      "    ",
      "    # 风控检查",
      "    for pos in positions:",
      "        stock = pos.m_strInstrumentID",
      "        current_price = ContextInfo.get_last_price(stock)",
      "        ",
      "        if stock in g.buy_prices:",
      "            pnl = (current_price - g.buy_prices[stock]) / g.buy_prices[stock]",
      "            if pnl <= -STOP_LOSS or pnl >= TAKE_PROFIT:",
      "                ContextInfo.order(stock, -pos.m_nVolume, ContextInfo.MARKET_SH_SZ)",
      "                del g.buy_prices[stock]",
      "    ",
      "    # 获取信号",
      "    signals = get_signals(ContextInfo)",
      "    ",
      "    # 执行交易",
      "    if signals:",
      "        capital = ContextInfo.get_account_info(ContextInfo.accout_id).m_dBalance",
      "        per_stock_value = capital * MAX_POSITION",
      "        ",
      "        for stock, score in sorted(signals.items(), key=lambda x: x[1], reverse=True)[:10]:",
      "            price = ContextInfo.get_last_price(stock)",
      "            volume = int(per_stock_value / price / 100) * 100",
      "            if volume >= 100:",
      "                ContextInfo.order(stock, volume, ContextInfo.MARKET_SH_SZ)",
      "                g.buy_prices[stock] = price",
      "",
      "",
      "def get_signals(ContextInfo):",
      "    \"\"\"获取交易信号\"\"\"",
      "    signals = {}",
      "    # TODO: 实现选股逻辑",
      "    return signals",
      ""
    ],
    "description": "完整的QMT策略模板"
  },

  "TRQuant Momentum Factor": {
    "prefix": ["trq-momentum", "factor-momentum"],
    "body": [
      "def calculate_momentum(stock, period=${1:20}):",
      "    \"\"\"",
      "    计算动量因子",
      "    ",
      "    Args:",
      "        stock: 股票代码",
      "        period: 计算周期",
      "    ",
      "    Returns:",
      "        float: 动量值",
      "    \"\"\"",
      "    prices = get_price(",
      "        stock,",
      "        end_date=context.current_dt,",
      "        count=period + 1,",
      "        fields=['close']",
      "    )['close']",
      "    ",
      "    if len(prices) < period + 1:",
      "        return 0",
      "    ",
      "    return (prices.iloc[-1] - prices.iloc[0]) / prices.iloc[0]",
      ""
    ],
    "description": "动量因子计算函数"
  },

  "TRQuant RSI Factor": {
    "prefix": ["trq-rsi", "factor-rsi"],
    "body": [
      "def calculate_rsi(stock, period=${1:14}):",
      "    \"\"\"",
      "    计算RSI指标",
      "    ",
      "    Args:",
      "        stock: 股票代码",
      "        period: RSI周期",
      "    ",
      "    Returns:",
      "        float: RSI值(0-100)",
      "    \"\"\"",
      "    prices = get_price(",
      "        stock,",
      "        end_date=context.current_dt,",
      "        count=period + 2,",
      "        fields=['close']",
      "    )['close']",
      "    ",
      "    if len(prices) < period + 1:",
      "        return 50",
      "    ",
      "    delta = prices.diff()",
      "    gain = (delta.where(delta > 0, 0)).rolling(window=period).mean()",
      "    loss = (-delta.where(delta < 0, 0)).rolling(window=period).mean()",
      "    ",
      "    rs = gain / loss",
      "    rsi = 100 - (100 / (1 + rs))",
      "    ",
      "    return rsi.iloc[-1]",
      ""
    ],
    "description": "RSI指标计算函数"
  },

  "TRQuant Stop Loss": {
    "prefix": ["trq-stoploss", "risk-stoploss"],
    "body": [
      "def check_stop_loss(context, stock, stop_loss_ratio=${1:0.08}):",
      "    \"\"\"",
      "    止损检查",
      "    ",
      "    Args:",
      "        context: 上下文",
      "        stock: 股票代码",
      "        stop_loss_ratio: 止损比例",
      "    ",
      "    Returns:",
      "        bool: 是否触发止损",
      "    \"\"\"",
      "    if stock not in context.portfolio.positions:",
      "        return False",
      "    ",
      "    position = context.portfolio.positions[stock]",
      "    pnl = (position.price - position.avg_cost) / position.avg_cost",
      "    ",
      "    if pnl <= -stop_loss_ratio:",
      "        log.warn(f\"触发止损: {stock}, 亏损 {pnl*100:.2f}%\")",
      "        order_target_percent(stock, 0)",
      "        return True",
      "    ",
      "    return False",
      ""
    ],
    "description": "止损检查函数"
  },

  "TRQuant Trailing Stop": {
    "prefix": ["trq-trailing", "risk-trailing"],
    "body": [
      "def trailing_stop(context, stock, trail_percent=${1:0.1}):",
      "    \"\"\"",
      "    追踪止损",
      "    ",
      "    Args:",
      "        context: 上下文",
      "        stock: 股票代码",
      "        trail_percent: 追踪止损比例",
      "    ",
      "    Returns:",
      "        bool: 是否触发止损",
      "    \"\"\"",
      "    if stock not in context.portfolio.positions:",
      "        return False",
      "    ",
      "    current_price = context.portfolio.positions[stock].price",
      "    ",
      "    # 记录最高价",
      "    if not hasattr(g, 'high_prices'):",
      "        g.high_prices = {}",
      "    ",
      "    if stock not in g.high_prices:",
      "        g.high_prices[stock] = current_price",
      "    else:",
      "        g.high_prices[stock] = max(g.high_prices[stock], current_price)",
      "    ",
      "    drawdown = (g.high_prices[stock] - current_price) / g.high_prices[stock]",
      "    ",
      "    if drawdown >= trail_percent:",
      "        log.warn(f\"追踪止损: {stock}, 回撤 {drawdown*100:.2f}%\")",
      "        order_target_percent(stock, 0)",
      "        del g.high_prices[stock]",
      "        return True",
      "    ",
      "    return False",
      ""
    ],
    "description": "追踪止损函数"
  },

  "TRQuant Filter Stocks": {
    "prefix": ["trq-filter", "filter-stocks"],
    "body": [
      "def filter_stocks(stocks):",
      "    \"\"\"",
      "    过滤不可交易股票",
      "    ",
      "    Args:",
      "        stocks: 股票列表",
      "    ",
      "    Returns:",
      "        list: 过滤后的股票",
      "    \"\"\"",
      "    filtered = []",
      "    current_data = get_current_data()",
      "    ",
      "    for stock in stocks:",
      "        # 跳过ST",
      "        if is_st(stock):",
      "            continue",
      "        # 跳过停牌",
      "        if is_suspended(stock):",
      "            continue",
      "        # 跳过涨跌停",
      "        if stock in current_data:",
      "            data = current_data[stock]",
      "            if data.last_price >= data.high_limit * 0.999:",
      "                continue",
      "            if data.last_price <= data.low_limit * 1.001:",
      "                continue",
      "        ",
      "        filtered.append(stock)",
      "    ",
      "    return filtered",
      ""
    ],
    "description": "股票过滤函数"
  },

  "TRQuant Multi-Factor Score": {
    "prefix": ["trq-multifactor", "factor-composite"],
    "body": [
      "def calculate_composite_score(stock, factors):",
      "    \"\"\"",
      "    计算多因子综合得分",
      "    ",
      "    Args:",
      "        stock: 股票代码",
      "        factors: 因子列表 [(因子名, 权重), ...]",
      "    ",
      "    Returns:",
      "        float: 综合得分",
      "    \"\"\"",
      "    scores = {}",
      "    ",
      "    # 计算各因子",
      "    for factor_name, weight in factors:",
      "        if factor_name == 'momentum':",
      "            scores[factor_name] = calculate_momentum(stock) * weight",
      "        elif factor_name == 'rsi':",
      "            # RSI归一化到0-1",
      "            rsi = calculate_rsi(stock)",
      "            scores[factor_name] = (1 - abs(rsi - 50) / 50) * weight",
      "        elif factor_name == 'pe':",
      "            pe = get_pe_ratio(stock)",
      "            if pe and pe > 0:",
      "                scores[factor_name] = (1 / pe) * weight",
      "        # 添加更多因子...",
      "    ",
      "    return sum(scores.values())",
      ""
    ],
    "description": "多因子综合评分函数"
  }
}




